{% extends "base.html" %}
{% load static %}
{% block title %}-post list{% endblock title %}

{% block content %}
    {% if messages %}
      {% for message in messages %}
        <!-- <div class="alert alert-{{ message.tags }} alert-dismissible" role="alert"> -->
        <li>{{message}}</li>
      {% endfor %}
    {% endif %}
    <h2>Liste des publications</h2>
    <a href="{% url 'create_post' %}">Ajouter un publication</a>
    <a href="{% url 'logout' %}">Déconnexion</a>
    
    <div class="container" id="post-ajax">
      {% include "post/ajax_post_list.html" %}
    </div>
{% endblock content %}

{% block styles %}
  <link rel="stylesheet" href="{% static 'assets/css/feed.css' %}">
{% endblock styles %}

{% block dom %}
  const cookie = getCookie('csrftoken')
  const url = '{% url "like_item" %}'
  let options = {
    method: 'POST',
    headers: {
      'X-CSRFToken': cookie,
    },
    mode: 'same-origin'
  }
  document.querySelectorAll(".total-post-btn").forEach(button =>{
    button.addEventListener('click', function(e){
      let formData = new FormData()
      formData.append('item_id', button.dataset.item_id)
      formData.append('action', button.dataset.action)
      formData.append('model', button.dataset.model)
      options['body'] = formData
      
      fetch(url, options).then(resp => resp.json())
        .then(data => {
          if(data['status'] == 'success'){
            let previous = button.dataset.action;
            let action = previous == 'like' ? 'unlike' : 'like';
            button.dataset.action = action
            button.classList.toggle('text-primary')
            let span = button.querySelector('span')
            let totalCount = parseInt(span.innerHTML)
            span.innerHTML = previous == 'like' ? totalCount + 1 : totalCount - 1
          }
        })
    })
  })

  // Cette fonction permet d'ajouter la pagination en scrollant
  function paginatorwithAjax(){
    let page = 1;
    var emptyPage = false;
    var canRequest = false;
    // écoute moi l'evenement scroll de ma fenêtre
    window.addEventListener('scroll', function(e){
      // récupère la totalité de la page et sa position
      let marginY = document.body.clientHeight - window.innerHeight - 200
      if(window.pageYOffset > marginY && !emptyPage && !canRequest){
        canRequest = true;
        page += 1;
        const spinner = `<div class="spinner">Loading...</div>`
        var postList = document.querySelector('#post-ajax')
        postList.insertAdjacentHTML('beforeEnd', spinner)
        const targetSpinner = postList.querySelector('.spinner')
        fetch(`?page_only=1&page=${page}`)
          .then(resp => resp.text())
          .then(data => {
            // si les données récupère au niveau du serveur est vide
            if(data == ''){
              emptyPage = true
              if(targetSpinner){
                postList.removeChild(targetSpinner)
              }
            }
            else{
              postList.removeChild(targetSpinner)
              postList.insertAdjacentHTML('beforeEnd', data)
              canRequest = false 
            }
          })
      }
    })
  }

  // Cette fonction permet d'ajouter un commentaire
  function addCommentWithAjax(){
    const url = '{% url "add_ajax_comment" %}'
    let options = {
      method: 'POST',
      headers: {
        'X-CSRFToken': cookie,
      },
      mode: 'same-origin'
    };

    document.querySelectorAll('.send-comment').forEach(sendButton => {
      sendButton.addEventListener('click', function(e) {
        let socialComment = sendButton.closest('.social-comment');
        let textarea = socialComment.querySelector('textarea');
        let comment = textarea.value.trim();
        let post_id = textarea.dataset.id;
  
        if (comment && post_id) {
          let formData = new FormData();
          formData.append('comment', comment);
          formData.append('id', post_id);
          options['body'] = formData;
  
          fetch(url, options)
            .then(resp => resp.text())
            .then(data => {
              if (data === 'error') {
                console.log('error');
              } else {
                socialComment.insertAdjacentHTML('beforebegin', data);
                textarea.value = ''; // clear the textarea
              }
            })
            .catch(error => console.error('Error:', error));
        }
      });
    });
  }

  addCommentWithAjax()
  paginatorwithAjax()
{% endblock dom %}
